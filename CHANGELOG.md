# DMP Tool Apollo Server Change Log

## v0.2 - Initial deploy to the stage environment

### Added
- Added data migrations for new `versionedSectionTags` table and seed script
- Added `maxDisplayOrder` queries to Section model
- Added `aws-process.sh` to allow migrations to be run in the AWS environment
- Added `init-tables` and `init-seed` data migration files
- Added `queryWithPagination` function to `MySQLModel`.
- Added `VersionedSectionSearchResult` to optimize the query for displaying an org's published sections and the bestPractice sections
- Added `popularFunders` query to the `affiliations` resolver
- Added `accessLevel` to projectCollaborator and removed `userId`
- Added new resolvers related to `projectCollaborators`. Also, when project is created, automatically add user as `projectCollaborator` with `access level`= `OWN`
- Added dynamoDb to the docker-compose file and setup dev to use the local instance
- Added tests for `plan` resolver and added tests for `contributor` resolver's queries
- Added mocks for most of the MySQL tables and the Dynamo table
- Added a new `dynamo` datasource (to replace the DMPHub API one ... much faster to access the table directly)
- Added `getAwards` method to `DMPHubAPI`.
- Added `searchExternalProjects` query and `projectImport` mutation.
- Added `TemplateSearchResult`, `VersionedTemplateSearchResult` and `ProjectSearchResult` to optimize querying
- Added `sections` to `Plan` schema and to plan resolver
- Added the `relatedWorks` data migration
- Added model and resolvers for `RelatedWork`
- Added model and resolvers mutations for `PlanContributor` and `PlanFunder`
- Added the `Answer`, `AnswerComment` model and supporting resolvers
- Added the `PlanVersion` table and model
- Added a `commonStandardService` and a `planService`
- Added the `apiTarget` to the `affiliations` table
- Added `Plan`, `PlanFunder`, `PlanContributor`, `ProjectCollaborator`, `DMP` and `RelatedIdentifier` models
- Added data-migration script to add additional columns to the `plans` table
- Added data-migration to add `isPrimaryContact` flag to the `planContributors` table
- Added new seed data-migration for `plans`, `planContributors`, `planFunders`
- Added "mocks" for use in tests for `Affiliation`, `Collaborator` (Template/Project), `Contributor` (Project/Plan), `ContributorRole`, `Funder` (Project/Plan), `Plan`
- Added a `findById` function to the `VersionedTemplate` model
- Added a default ORCID base URL and regex to `User` model
- Added `getMockDOI` and `getMockDMPId` helper functions for tests
- Added an `IsNullOrUndefined` and `valueIsEmpty` (null, undefined or an empty string) helper functions
- Added `config/dmpHubConfig.ts` for DMPHub specific configuration
- Added `projectPlans` join table which acts as a bridge between the `projects` table in the MySQL database and the `plans` stored in the DMPHub DynamoDB table
- Added model mocks for Affiliation and Collaborator
- Added resolver integration tests for affilian and collaborator resolvers
- Added `useSampleTextAsDefault` column to questions table and add `admins` to Template schema and chained it in the resolver
- Added `requestId` to the Apollo context
- Added `questionOptions` schema, resolver and `QuestionOption` model, which will be used for `option` question types
- Added a new query to get all versionedTemplates, called `myVersionedTemplates`, under user's affiliation, and added a new method in the model called `findByAffiliationId`
- Updated `templates` resolver to handle updates to `sections` and `questions` when copying a `template`
- Added "remove" method to SectionTag model. Updated "updateSection" method in Section resolvers to remove sectionTags when user is updating their Section. Added "getTagsToRemove" method to the Section resolver. Added associated unit tests.
- Added "lastPublishedDate" field to templates table, and changed "currentVersion" field to "lastPublishedVersion"
- Added support for creating "other" affiliations
- Added update and updatePassword to User
- Added resolvers for User
- Added userService to handle random password generation, anonymization and merging
- Added recordLogIn and update functions to User model
- Added data-fns package to help with Date validation and formatting
- Added Language model, resolver and type. Added LanguageId to User and Template
- Built Question resolvers and models(#13)
- Fixed some bugs to allow frontend to access token change(Frontend #116)
- Added data migrations for QuestionType, Question, QuestionCondition, VersionedQuestion and VersionedQuestionCondition
- Added missing VersionedQuestionCondition schema file
- Added schemas for Question, QuestionType, QuestionCondition and VersionedQuestion
- Added resolvers and models for Section, Tag and VersionedSection
- Added acceptedTerms to User schema and to user sql table
- Added schema for Section and Tag
- Initial schema, model, mocks and resolver for Templates
- Initial schema, model, mocks and resolver for Collaborators
- added templateService to assist with actions that work on a Template and all of it's child objects
- Added stub emailService as a placeholder for now. We will build that out once the AWS infrastructire is in place
- Added new `src/__mocks__/context` to mock the Apollo Server context object
- Added `insert`, `update` `delete` functions to the `MySqlModel` abstract class
- Missing data-migration for the dataMigrations table
- Script to nuke the DB so it can be easily rebuilt from scratch
- Added husky precommit tasks
- Added data migrations for Section and Tag
- Added Redis to the docker-compose file
- Added Cache data source (and tests)
- Added CSRF middleware
- Added signoutController and refreshTokenController
- Added tests for all Controllers
- Added supertest to support integration tests
- Added integration tests for token management (signin, signup, signout, refresh)
- Data migrations for affiliations table
- Added Project, ProjectContributor, ProjectFunder schemas and supporting tables
- Added Plan, PlanContributor, PlanCollaborator, PlanFunder, PlanFeedback, PlanFeedbackComment, Answer and AnswerComment schemas and supporting tables
- Added models and resolvers for MetadataStandard, Repository, ResearchDomain, and License
- Added models and resolvers for ProjectContributor, ProjectFunder, ProjectOutput and Project

### Updated
- Updated `addSection` resolver to properly copy questions and tags when creating a new section by copying one
- Renamed the `outputTypes` table to `projectOutputTypes`
- Updated `buildspec` to allow for a "MODE" env variable to be set so that we can run migrations, tests and the build separately
- Updated `publishedTemplates`, `users`, `myTemplates`, `topLevelResearchDomains`, `repositories`, `myProjects`, `metadataStandards`, `licenses`, `affiliations` queries to use the new `paginationService`
- Updated `publishedTemplates`, `users`, `myTemplates`, `topLevelResearchDomains`, `repositories`, `myProjects`, `metadataStandards`, `licenses`, `affiliations` queries to use the new `paginationService`
- Updated `publishedSections` resolver to return the new `VersionedSectionSearchResult` array
- Format ORCID identifiers consistently, in the `Contributor` and `User` models, the `projectImport` resolver and `orcid` scalar.
- Changed a number of GraphQL definitions to PascalCase.
- Fixed projectCollaborators table which had an FKey on the plans table instead of the projects table
- Updated the `dmpHubAPI` datasource to support CRUD operations
- Updated the `Plan` resolver and model to support mutations
- Updated the `Affiliation` schema and model to include the new `apiTarget` property.
- Renamed old `planCollaborators` table to `projectCollaborators`
- Renamed old `PlanCollaborator` resolved functions so that they point to `ProjectCollaborator` since we decided to capture that at the project level
- Updated `ProjectService` permission check so that it looks at the ProjectCollaborators as well
- Updated `QuestionCondition` model to return the object with functions
- Updated `ContributorRole` model so that it has functions to associate them with `PlanContributor` records.
- Moved config for `dmpHubAPI` from the datasource into a `config/dmphubConfig.ts` file
- Removed old unused `Affiliation` methods from `dmpHubAPI` and added `getDMP` and `validate` (for use in the near future when syncing changes within our system and the DMPHub)
- Updated structure of `cacheConfig.ts` to match other configs
- Moved config for `MysSQLDataSource` from the datasource into its config file
- Moved `SigTerm` handler tests for `mysql` into a separate test file. They were failing for some reason when run together
- Refactored `context.ts` and tests to use new `dmpHubAPI` datasource
- Refactored old "mocks" to extract duplicative code into the `MySQLMock.ts`
- Update existing resolver tests to use new mocks
- Made sure all config entries were covered in the `__tests__/setup.ts`
- Updated the `emailService` to support `projectCollaborators` instead of `planCollaborators`
- Updated `question` and `section` resolvers to update `isDirty` in associated `template` when mutations were made. That way a user can `Save Draft` in the `Edit Template` page.
- Updated models and resolvers to handle errors in a consistent way
- Refactored the way Sections handle the association with Tag to follow pattern used elsewhere
- Updated `formatLogMessage` to accept the Apollo context instead of the logger so that it can being to record the `requestId`, `jti` and `userId` (when available)
- Updated `questionTypes` table to remove 'Rich Text Editor' and to add `usageDescription`. Also, updated Question model's `create` method to allow for entries with duplicate `questionText`
- Updated User update method to prevent password manipulation
- Updated User registration so that the terms and conditions must have been accepted
- Updated User schema, model and data migrations with new properties
- Change default JWT TTL to 30 minutes
- Added user id to the JTI to help ensure uniqueness
- Update sign out controller to always clear the cookies and return 200 regardless of the state of the tokens
- Updated `src/context.ts` to use a `buildContext` wrapper function that can be called when building the context for Apollo Server and our `signin` and `signup` endpoints.
- Updated use of `toUTCString()` to `toISOString()`
- Updated `tokenService` to properly catch and throw errors
- Updated `graphQLErrors` with more error types
- Added MariaDB to docker-compose
- data-migrations/README.md with instructions on running migrations in the Docker container
- tokenService now supports refresh tokens, CSRF tokens and signout
- updated express middelware to fetch the access token and refresh tokens from the cookies instead of the headers
- removed old oauth-server package which had security vulnerabilities
- moved authMiddleware function from the router.ts into its own class in src/middelware
- updated Affiliation Schema, Resolver, Models to use new affiliations tables in the database
- updated all of the cache key structures to wrap them in `{}` due to the way Redis handles keys in cluster mode
- updated emailService to use nodemailer and to support emailConfirmation templateCollaboration and planCollaboration email messages
- added bestPractice flag to the Section

### Removed
- Dropped all previous `data-migration` files in favor of the new `init-tables` and `init-seed` files
- Removed duplicate section check from `Section.create` that was just going off of the "name"
- Dropped the `PlanVersion` table
- Removed `prepareAPITarget` function.
- Removed `id` from `Project` model's constructor (already handled in base `MySQLModel`)
- Removed old `dmphubAPI` datasource and renamed `dmptoolAPI` to `dmpHubAPI`
- Old DMPHubAPI datasource and renamed DMPToolAPI to DMPHubAPI since that one had all of the new auth logic

### Fixed
- Fixed an issue where adding `templateCollaborators` was failing due to the fact that the `userId` field was required.
-Was getting `undefined` bestPractice in `updateTemplate` when none was passed in because of the logic on how it was set. Added a check for whether `bestPractice` is defined before setting value. Also, added an update to `createTemplateVersion`, so that errors from the `generateTemplateVersion` will be caught and passed back in graphql response. Previously, when trying to save a DRAFT of a template, the mutation wouldn't return an error to the client, even though the `Save draft` did not successfully complete. [#265]
- Removed `Copy of` from in front of copied `Section` and `Template` names [#261]
- Fixed an issue where adding `templateCollaborators` was failing due to the fact that the `userId` field was required.
- Fixed an issue where adding `projectCollaborators` was failing due to the fact that the `userId` field was required. This should not be required to add a new collaborator [#260]
- When calling `updatePlanContributors`, the resolver should set isPrimaryContact to `false` for all contributors other than the one marked as isPrimary.
- Fixed an issue where Jest tests failed on Linux due to case-sensitive file paths. The tests passed on macOS because its file system is case-insensitive by default.
- Fixed bugs related to addPlanContributor and updatePlanContributor since these were not working without missing contributorRoles
- Converted DateTimeISO to String in schemas so that dates could be inserted into mariaDB database, and updated MySqlModel and associated unit test

## v0.0.1
Initial Apollo Server build

### Added
- Added unit tests for User model and contributorRole resolver, and added @types/pino
- Added editor config
- initial Apollo server config
- Initial Schema for ContributorRole
- Initial Schema for DMSP
- Resolvers for ContributorRole
- Initial resolver to fetch a single DMSP from the DMPHub API
- Initial DMPHub API data source
- Initial MySQL data source
- Custom GraphQL scalars for ROR, ORCID and DMSP IDs
- Mechanism for Apollo to use mocks when a resolver has not yet been implemented
- Mocks for User
- Data migration mechanism `./data-migrations/process.sh`
- Documentation!
- Local Docker Compose config
- Pino logger with ECS formatter
- Plugin to log request/response lifecycle events
- Add Logger to the context and then used it in the resolvers
- Schema, Mocks, Models and Resolvers for Affiliations and tests for the Models and Resolvers
- Added new DataSource for the DmptoolApi with endpoints for Affiliations and a new mock for this data source for use in tests

### Updated
- Made some updates to auth code based on testing out recent changes with frontend [#34]
